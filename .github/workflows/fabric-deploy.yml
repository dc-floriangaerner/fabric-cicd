name: Deploy to Microsoft Fabric

# Workflow triggers:
# 1. Automatic: Push to main branch with changes in workspaces/** paths
#    - Deploys ONLY changed workspaces to Dev environment
#    - Changes outside workspaces/ directory do NOT trigger deployment
# 2. Manual: workflow_dispatch with environment selection (dev/test/prod)
#    - Deploys ALL workspaces to selected environment
#    - Useful for promoting to Test/Prod or re-deploying Dev
on:
  push:
    branches:
      - main
    paths:
      - 'workspaces/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  PYTHON_VERSION: '3.12'
  WORKSPACES_DIRECTORY: 'workspaces'

jobs:
  # Change detection job: Determines which workspaces to deploy
  # - For automatic triggers (push): Returns only workspace folders with file changes
  # - For manual triggers (workflow_dispatch): Returns all workspace folders
  # Output 'workspaces': Comma-separated list of workspace folders to deploy
  # Output 'all_workspaces': Comma-separated list of all available workspace folders
  detect-changes:
    name: Detect Changed Workspaces
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.detect.outputs.workspaces }}
      all_workspaces: ${{ steps.detect.outputs.all_workspaces }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed workspaces
        id: detect
        run: |
          # Check if workspaces directory exists
          if [ ! -d "${{ env.WORKSPACES_DIRECTORY }}" ]; then
            echo "Error: Workspaces directory '${{ env.WORKSPACES_DIRECTORY }}' does not exist." >&2
            echo "all_workspaces=" >> "$GITHUB_OUTPUT"
            echo "workspaces=" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          # Get all workspace folders
          all_workspaces=$(find "${{ env.WORKSPACES_DIRECTORY }}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | tr '\n' ',' | sed 's/,$//')
          echo "all_workspaces=$all_workspaces" >> $GITHUB_OUTPUT
          echo "All workspaces: $all_workspaces"
          
          # For manual trigger, deploy all workspaces
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger detected - deploying all workspaces"
            echo "workspaces=$all_workspaces" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For push events, detect changed workspaces
          changed_files=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$changed_files"
          
          changed_workspaces=$(echo "$changed_files" | grep "^${{ env.WORKSPACES_DIRECTORY }}/" | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$changed_workspaces" ]; then
            echo "No workspace changes detected"
            echo "workspaces=" >> $GITHUB_OUTPUT
          else
            echo "Changed workspaces: $changed_workspaces"
            echo "workspaces=$changed_workspaces" >> $GITHUB_OUTPUT
          fi

  # Validation job: Validates all workspace files before deployment
  # - Checks JSON syntax in all .json files
  # - Validates Python notebook syntax in notebook-content.py files
  # - Ensures required metadata files exist (lakehouse.metadata.json, alm.settings.json)
  # - Validates YAML syntax in workspace parameter.yml files
  # Fails entire workflow if any validation fails
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.workspaces != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find "${{ env.WORKSPACES_DIRECTORY }}" -name "*.json" -type f | while IFS= read -r file; do
            echo "Checking: $file"
            if ! python -m json.tool "$file" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in $file"
              exit 1
            fi
          done
          echo "All JSON files are valid"

      - name: Validate Python notebooks
        run: |
          echo "Validating Python notebook syntax..."
          find "${{ env.WORKSPACES_DIRECTORY }}" -name "notebook-content.py" -type f | while IFS= read -r file; do
            echo "Checking: $file"
            if ! python -m py_compile "$file" > /dev/null 2>&1; then
              echo "ERROR: Syntax error in notebook $file"
              exit 1
            else
              echo "Checked: $file"
            fi
          done
          echo "Notebook validation complete"

      - name: Check required metadata files
        run: |
          echo "Checking for required metadata files..."
          # Check lakehouses have required files
          find "${{ env.WORKSPACES_DIRECTORY }}" -type d -name "*.Lakehouse" | while IFS= read -r dir; do
            echo "Checking lakehouse: $dir"
            [ -f "$dir/lakehouse.metadata.json" ] || (echo "Missing lakehouse.metadata.json in $dir" && exit 1)
            [ -f "$dir/alm.settings.json" ] || (echo "Missing alm.settings.json in $dir" && exit 1)
          done
          echo "All required metadata files present"

      - name: Validate workspace parameter.yml files
        run: |
          echo "Validating workspace parameter.yml files..."
          find "${{ env.WORKSPACES_DIRECTORY }}" -mindepth 2 -maxdepth 2 -name "parameter.yml" -type f | while IFS= read -r file; do
            echo "Checking: $file"
            python -c "import yaml; yaml.safe_load(open('$file'))" || (echo "ERROR: Invalid YAML in $file" && exit 1)
          done
          echo "All parameter.yml files are valid"

  # Dev deployment job
  # Triggers:
  #   - Automatic: On push to main with changes in workspaces/** (deploys only changed workspaces)
  #   - Manual: Via workflow_dispatch when 'dev' environment is selected (deploys all workspaces)
  # Workspace selection: Changed workspaces only for auto-trigger, all workspaces for manual trigger
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [detect-changes, static-analysis]
    if: |
      needs.detect-changes.outputs.workspaces != '' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev'))
    environment:
      name: dev
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'dev'
          workspaces: ${{ needs.detect-changes.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine trigger type
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "- **Trigger Type**: Automatic (changed workspaces)" >> $GITHUB_STEP_SUMMARY
            
            # Show excluded workspaces
            all_workspaces="${{ needs.detect-changes.outputs.all_workspaces }}"
            deployed_workspaces="${{ needs.detect-changes.outputs.workspaces }}"
            
            if [ -n "$all_workspaces" ] && [ -n "$deployed_workspaces" ]; then
              IFS=',' read -ra ALL <<< "$all_workspaces"
              IFS=',' read -ra DEPLOYED <<< "$deployed_workspaces"
              
              excluded=""
              for workspace in "${ALL[@]}"; do
                if [[ ! " ${DEPLOYED[@]} " =~ " ${workspace} " ]]; then
                  if [ -z "$excluded" ]; then
                    excluded="$workspace"
                  else
                    excluded="$excluded, $workspace"
                  fi
                fi
              done
              
              if [ -n "$excluded" ]; then
                echo "- **Excluded Workspaces**: $excluded (no changes detected)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "- **Trigger Type**: Manual (all workspaces)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Count workspaces
          deployed_workspaces="${{ needs.detect-changes.outputs.workspaces }}"
          if [ -n "$deployed_workspaces" ]; then
            IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
            workspace_count=${#WORKSPACES[@]}
          else
            workspace_count=0
          fi
          
          echo "- **Environment**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $workspace_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List deployed workspaces with stage prefix
          if [ "$workspace_count" -gt 0 ]; then
            if [ "${{ job.status }}" == "success" ]; then
              echo "#### ✓ Deployed Workspaces:" >> $GITHUB_STEP_SUMMARY
            else
              echo "#### Deployment Attempted:" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            for workspace in "${WORKSPACES[@]}"; do
              if [ "${{ job.status }}" == "success" ]; then
                echo "- ✓ [D] $workspace" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ⚠️ [D] $workspace" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  # Test deployment job
  # Triggers:
  #   - Manual only: Via workflow_dispatch when 'test' environment is selected
  # Workspace selection: Always deploys all workspaces (not just changed ones)
  # Note: Requires manual approval if GitHub environment protection rules are configured
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: [detect-changes, static-analysis]
    if: |
      needs.detect-changes.outputs.workspaces != '' &&
      github.event_name == 'workflow_dispatch' && inputs.environment == 'test'
    environment:
      name: test
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'test'
          workspaces: ${{ needs.detect-changes.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          FABRIC_CAPACITY_ID_TEST: ${{ secrets.FABRIC_CAPACITY_ID_TEST }}
          FABRIC_CAPACITY_ID_PROD: ${{ secrets.FABRIC_CAPACITY_ID_PROD }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Type**: Manual (all workspaces)" >> $GITHUB_STEP_SUMMARY
          
          # Count workspaces
          deployed_workspaces="${{ needs.detect-changes.outputs.workspaces }}"
          if [ -n "$deployed_workspaces" ]; then
            IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
            workspace_count=${#WORKSPACES[@]}
          else
            workspace_count=0
          fi
          
          echo "- **Environment**: test" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $workspace_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List deployed workspaces with stage prefix
          if [ "$workspace_count" -gt 0 ]; then
            if [ "${{ job.status }}" == "success" ]; then
              echo "#### ✓ Deployed Workspaces:" >> $GITHUB_STEP_SUMMARY
            else
              echo "#### Deployment Attempted:" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            for workspace in "${WORKSPACES[@]}"; do
              if [ "${{ job.status }}" == "success" ]; then
                echo "- ✓ [T] $workspace" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ⚠️ [T] $workspace" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

  # Production deployment job
  # Triggers:
  #   - Manual only: Via workflow_dispatch when 'prod' environment is selected
  # Workspace selection: Always deploys all workspaces (not just changed ones)
  # Note: Requires manual approval if GitHub environment protection rules are configured
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [detect-changes, static-analysis]
    if: |
      needs.detect-changes.outputs.workspaces != '' &&
      github.event_name == 'workflow_dispatch' && inputs.environment == 'prod'
    environment:
      name: prod
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'prod'
          workspaces: ${{ needs.detect-changes.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          FABRIC_CAPACITY_ID_TEST: ${{ secrets.FABRIC_CAPACITY_ID_TEST }}
          FABRIC_CAPACITY_ID_PROD: ${{ secrets.FABRIC_CAPACITY_ID_PROD }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Type**: Manual (all workspaces)" >> $GITHUB_STEP_SUMMARY
          
          # Count workspaces
          deployed_workspaces="${{ needs.detect-changes.outputs.workspaces }}"
          if [ -n "$deployed_workspaces" ]; then
            IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
            workspace_count=${#WORKSPACES[@]}
          else
            workspace_count=0
          fi
          
          echo "- **Environment**: prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $workspace_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List deployed workspaces with stage prefix
          if [ "$workspace_count" -gt 0 ]; then
            if [ "${{ job.status }}" == "success" ]; then
              echo "#### ✓ Deployed Workspaces:" >> $GITHUB_STEP_SUMMARY
            else
              echo "#### Deployment Attempted:" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            for workspace in "${WORKSPACES[@]}"; do
              if [ "${{ job.status }}" == "success" ]; then
                echo "- ✓ [P] $workspace" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ⚠️ [P] $workspace" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
