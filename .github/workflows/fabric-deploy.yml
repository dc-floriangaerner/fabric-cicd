name: Deploy to Microsoft Fabric

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_to_test:
        description: 'Deploy to Test environment'
        required: false
        type: boolean
        default: false
      deploy_to_prod:
        description: 'Deploy to Production environment'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.12'
  REPOSITORY_DIRECTORY: 'Fabric Blueprint'
  DEV_WORKSPACE_NAME: '[D] Fabric Blueprint'
  TEST_WORKSPACE_NAME: '[T] Fabric Blueprint'
  PROD_WORKSPACE_NAME: '[P] Fabric Blueprint'

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          find "${{ env.REPOSITORY_DIRECTORY }}" -name "*.json" -type f | while read file; do
            echo "Checking: $file"
            if ! python -m json.tool "$file" > /dev/null 2>&1; then
              echo "ERROR: Invalid JSON in $file"
              exit 1
            fi
          done
          echo "All JSON files are valid"

      - name: Validate Python notebooks
        run: |
          echo "Validating Python notebook syntax..."
          find "${{ env.REPOSITORY_DIRECTORY }}" -name "notebook-content.py" -type f | while read file; do
            echo "Checking: $file"
            if ! python -m py_compile "$file" > /dev/null 2>&1; then
              echo "ERROR: Syntax error in notebook $file"
              exit 1
            else
              echo "Checked: $file"
            fi
          done
          echo "Notebook validation complete"

      - name: Check required metadata files
        run: |
          echo "Checking for required metadata files..."
          # Check lakehouses have required files
          find "${{ env.REPOSITORY_DIRECTORY }}" -type d -name "*.Lakehouse" | while read dir; do
            echo "Checking lakehouse: $dir"
            [ -f "$dir/lakehouse.metadata.json" ] || (echo "Missing lakehouse.metadata.json in $dir" && exit 1)
            [ -f "$dir/alm.settings.json" ] || (echo "Missing alm.settings.json in $dir" && exit 1)
          done
          echo "All required metadata files present"

  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: static-analysis
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !inputs.deploy_to_test && !inputs.deploy_to_prod)
    environment:
      name: dev
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fabric-cicd

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Deploy to Dev Workspace
        run: |
          python -u scripts/deploy-to-fabric.py \
            --workspace_name "${{ env.DEV_WORKSPACE_NAME }}" \
            --repository_directory "${{ env.REPOSITORY_DIRECTORY }}" \
            --environment "dev"

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ env.DEV_WORKSPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: static-analysis
    if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_test
    environment:
      name: test
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fabric-cicd

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Deploy to Test Workspace
        run: |
          python -u scripts/deploy-to-fabric.py \
            --workspace_name "${{ env.TEST_WORKSPACE_NAME }}" \
            --repository_directory "${{ env.REPOSITORY_DIRECTORY }}" \
            --environment "test"

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Test" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ env.TEST_WORKSPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: test" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [static-analysis]
    if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_prod
    environment:
      name: production
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fabric-cicd

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Deploy to Production Workspace
        run: |
          python -u scripts/deploy-to-fabric.py \
            --workspace_name "${{ env.PROD_WORKSPACE_NAME }}" \
            --repository_directory "${{ env.REPOSITORY_DIRECTORY }}" \
            --environment "prod"

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ env.PROD_WORKSPACE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
