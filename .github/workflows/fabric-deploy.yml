name: Deploy to Microsoft Fabric

# Workflow triggers:
# 1. Automatic: Push to main branch with changes in workspaces/** paths
#    - Deploys all workspaces to Dev environment
#    - Changes outside workspaces/ directory do NOT trigger deployment
# 2. Manual: workflow_dispatch with environment selection (dev/test/prod)
#    - Deploys all workspaces to selected environment
#    - Useful for promoting to Test/Prod or re-deploying Dev
on:
  push:
    branches:
      - main
    paths:
      - 'workspaces/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

env:
  PYTHON_VERSION: '3.12'
  WORKSPACES_DIRECTORY: 'workspaces'

jobs:
  # Get all workspaces job: Retrieves all workspace folders for deployment
  # Output 'workspaces': Comma-separated list of all workspace folders to deploy
  get-workspaces:
    name: Get Workspaces
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.get.outputs.workspaces }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get all workspaces
        id: get
        run: |
          # Check if workspaces directory exists
          if [ ! -d "${{ env.WORKSPACES_DIRECTORY }}" ]; then
            echo "Error: Workspaces directory '${{ env.WORKSPACES_DIRECTORY }}' does not exist." >&2
            echo "workspaces=" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          
          # Get all workspace folders
          all_workspaces=$(find "${{ env.WORKSPACES_DIRECTORY }}" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | tr '\n' ',' | sed 's/,$//')
          echo "workspaces=$all_workspaces" >> $GITHUB_OUTPUT
          echo "Workspaces to deploy: $all_workspaces"

  # Dev deployment job
  # Triggers:
  #   - Automatic: On push to main (deploys all workspaces)
  #   - Manual: Via workflow_dispatch when 'dev' environment is selected (deploys all workspaces)
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: get-workspaces
    if: |
      needs.get-workspaces.outputs.workspaces != '' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev'))
    environment:
      name: dev
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'dev'
          workspaces: ${{ needs.get-workspaces.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine trigger type
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "- **Trigger Type**: Automatic" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trigger Type**: Manual" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Read deployment results from JSON file if it exists
          if [ -f "deployment-results.json" ]; then
            total_workspaces=$(jq -r '.total_workspaces' deployment-results.json)
            successful_count=$(jq -r '.successful_count' deployment-results.json)
            failed_count=$(jq -r '.failed_count' deployment-results.json)
            duration=$(jq -r '.duration' deployment-results.json)
          else
            # Fallback to counting from input
            deployed_workspaces="${{ needs.get-workspaces.outputs.workspaces }}"
            if [ -n "$deployed_workspaces" ]; then
              IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
              total_workspaces=${#WORKSPACES[@]}
            else
              total_workspaces=0
            fi
            successful_count=0
            failed_count=$total_workspaces
            duration="N/A"
          fi
          
          echo "- **Environment**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $total_workspaces" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful**: $successful_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $failed_count" >> $GITHUB_STEP_SUMMARY
          # Format duration to 2 decimal places if it's a number
          if [[ "$duration" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            formatted_duration=$(printf "%.2f" "$duration")
            echo "- **Duration**: ${formatted_duration}s" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Duration**: ${duration}s" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List workspaces with individual status from JSON
          if [ -f "deployment-results.json" ] && [ "$total_workspaces" -gt 0 ]; then
            echo "#### Deployment Results:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Read and display each workspace status
            jq -r '.workspaces[] | "\(.status)|\(.full_name)|\(.error)"' deployment-results.json | while IFS='|' read -r status full_name error; do
              if [ "$status" == "success" ]; then
                echo "- ✓ $full_name" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ✗ $full_name" >> $GITHUB_STEP_SUMMARY
                if [ -n "$error" ]; then
                  echo "  - Error: $error" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          fi

  # Test deployment job
  # Triggers:
  #   - Manual only: Via workflow_dispatch when 'test' environment is selected
  # Note: Requires manual approval if GitHub environment protection rules are configured
  deploy-test:
    name: Deploy to Test
    runs-on: ubuntu-latest
    needs: get-workspaces
    if: |
      needs.get-workspaces.outputs.workspaces != '' &&
      github.event_name == 'workflow_dispatch' && inputs.environment == 'test'
    environment:
      name: test
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'test'
          workspaces: ${{ needs.get-workspaces.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          FABRIC_CAPACITY_ID_TEST: ${{ secrets.FABRIC_CAPACITY_ID_TEST }}
          FABRIC_CAPACITY_ID_PROD: ${{ secrets.FABRIC_CAPACITY_ID_PROD }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Type**: Manual" >> $GITHUB_STEP_SUMMARY
          
          # Read deployment results from JSON file if it exists
          if [ -f "deployment-results.json" ]; then
            total_workspaces=$(jq -r '.total_workspaces' deployment-results.json)
            successful_count=$(jq -r '.successful_count' deployment-results.json)
            failed_count=$(jq -r '.failed_count' deployment-results.json)
            duration=$(jq -r '.duration' deployment-results.json)
          else
            # Fallback to counting from input
            deployed_workspaces="${{ needs.get-workspaces.outputs.workspaces }}"
            if [ -n "$deployed_workspaces" ]; then
              IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
              total_workspaces=${#WORKSPACES[@]}
            else
              total_workspaces=0
            fi
            successful_count=0
            failed_count=$total_workspaces
            duration="N/A"
          fi
          
          echo "- **Environment**: test" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $total_workspaces" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful**: $successful_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $failed_count" >> $GITHUB_STEP_SUMMARY
          # Format duration to 2 decimal places if it's a number
          if [[ "$duration" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            formatted_duration=$(printf "%.2f" "$duration")
            echo "- **Duration**: ${formatted_duration}s" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Duration**: ${duration}s" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List workspaces with individual status from JSON
          if [ -f "deployment-results.json" ] && [ "$total_workspaces" -gt 0 ]; then
            echo "#### Deployment Results:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Read and display each workspace status
            jq -r '.workspaces[] | "\(.status)|\(.full_name)|\(.error)"' deployment-results.json | while IFS='|' read -r status full_name error; do
              if [ "$status" == "success" ]; then
                echo "- ✓ $full_name" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ✗ $full_name" >> $GITHUB_STEP_SUMMARY
                if [ -n "$error" ]; then
                  echo "  - Error: $error" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          fi

  # Production deployment job
  # Triggers:
  #   - Manual only: Via workflow_dispatch when 'prod' environment is selected
  # Note: Requires manual approval if GitHub environment protection rules are configured
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: get-workspaces
    if: |
      needs.get-workspaces.outputs.workspaces != '' &&
      github.event_name == 'workflow_dispatch' && inputs.environment == 'prod'
    environment:
      name: prod
      url: https://app.fabric.microsoft.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy using composite action
        uses: ./.github/actions/deploy-workspace
        with:
          environment: 'prod'
          workspaces: ${{ needs.get-workspaces.outputs.workspaces }}
          workspaces-directory: ${{ env.WORKSPACES_DIRECTORY }}
          python-version: ${{ env.PYTHON_VERSION }}
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          FABRIC_CAPACITY_ID_DEV: ${{ secrets.FABRIC_CAPACITY_ID_DEV }}
          FABRIC_CAPACITY_ID_TEST: ${{ secrets.FABRIC_CAPACITY_ID_TEST }}
          FABRIC_CAPACITY_ID_PROD: ${{ secrets.FABRIC_CAPACITY_ID_PROD }}
          DEPLOYMENT_SP_OBJECT_ID: ${{ secrets.DEPLOYMENT_SP_OBJECT_ID }}
          FABRIC_ADMIN_GROUP_ID: ${{ secrets.FABRIC_ADMIN_GROUP_ID }}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary - Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Type**: Manual" >> $GITHUB_STEP_SUMMARY
          
          # Read deployment results from JSON file if it exists
          if [ -f "deployment-results.json" ]; then
            total_workspaces=$(jq -r '.total_workspaces' deployment-results.json)
            successful_count=$(jq -r '.successful_count' deployment-results.json)
            failed_count=$(jq -r '.failed_count' deployment-results.json)
            duration=$(jq -r '.duration' deployment-results.json)
          else
            # Fallback to counting from input
            deployed_workspaces="${{ needs.get-workspaces.outputs.workspaces }}"
            if [ -n "$deployed_workspaces" ]; then
              IFS=',' read -ra WORKSPACES <<< "$deployed_workspaces"
              total_workspaces=${#WORKSPACES[@]}
            else
              total_workspaces=0
            fi
            successful_count=0
            failed_count=$total_workspaces
            duration="N/A"
          fi
          
          echo "- **Environment**: prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Workspaces**: $total_workspaces" >> $GITHUB_STEP_SUMMARY
          echo "- **Successful**: $successful_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $failed_count" >> $GITHUB_STEP_SUMMARY
          # Format duration to 2 decimal places if it's a number
          if [[ "$duration" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            formatted_duration=$(printf "%.2f" "$duration")
            echo "- **Duration**: ${formatted_duration}s" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Duration**: ${duration}s" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # List workspaces with individual status from JSON
          if [ -f "deployment-results.json" ] && [ "$total_workspaces" -gt 0 ]; then
            echo "#### Deployment Results:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Read and display each workspace status
            jq -r '.workspaces[] | "\(.status)|\(.full_name)|\(.error)"' deployment-results.json | while IFS='|' read -r status full_name error; do
              if [ "$status" == "success" ]; then
                echo "- ✓ $full_name" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ✗ $full_name" >> $GITHUB_STEP_SUMMARY
                if [ -n "$error" ]; then
                  echo "  - Error: $error" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          fi
